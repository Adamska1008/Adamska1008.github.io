<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"adamska1008.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="本段内容包括链接的基本内容，静态链接库与动态链接库，库打桩机制。">
<meta property="og:type" content="article">
<meta property="og:title" content="CSAPP笔记（六）—— 链接">
<meta property="og:url" content="https://adamska1008.github.io/2022/06/03/study-notes-CSAPP-6/index.html">
<meta property="og:site_name" content="Adamska&#39;s Blog">
<meta property="og:description" content="本段内容包括链接的基本内容，静态链接库与动态链接库，库打桩机制。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/06/03/abRD7xsMc9HQzlp.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/05/ZxtY869l7IHJaG1.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/03/HlouNzSfXPjQdhI.png">
<meta property="article:published_time" content="2022-06-03T07:39:35.000Z">
<meta property="article:modified_time" content="2022-07-05T07:36:42.734Z">
<meta property="article:author" content="Adamska">
<meta property="article:tag" content="CSAPP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/06/03/abRD7xsMc9HQzlp.png">


<link rel="canonical" href="https://adamska1008.github.io/2022/06/03/study-notes-CSAPP-6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://adamska1008.github.io/2022/06/03/study-notes-CSAPP-6/","path":"2022/06/03/study-notes-CSAPP-6/","title":"CSAPP笔记（六）—— 链接"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>CSAPP笔记（六）—— 链接 | Adamska's Blog</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Adamska's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5"><span class="nav-number">1.</span> <span class="nav-text"> 静态链接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6"><span class="nav-number">2.</span> <span class="nav-text"> 目标文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E9%87%8D%E5%AE%9A%E4%BD%8D%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.</span> <span class="nav-text"> 可重定位目标文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%A6%E5%8F%B7%E5%92%8C%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="nav-number">3.</span> <span class="nav-text"> 符号和符号表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%A6%E5%8F%B7%E8%A7%A3%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text"> 符号解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90%E5%A4%9A%E9%87%8D%E5%AE%9A%E4%B9%89%E7%9A%84%E5%85%A8%E5%B1%80%E7%AC%A6%E5%8F%B7"><span class="nav-number">4.1.</span> <span class="nav-text"> 解析多重定义的全局符号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E9%9D%99%E6%80%81%E5%BA%93%E9%93%BE%E6%8E%A5"><span class="nav-number">4.2.</span> <span class="nav-text"> 与静态库链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E5%BA%93%E8%A7%A3%E6%9E%90%E5%BC%95%E7%94%A8"><span class="nav-number">4.3.</span> <span class="nav-text"> 静态库解析引用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D"><span class="nav-number">5.</span> <span class="nav-text"> 重定位</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D%E6%9D%A1%E7%9B%AE"><span class="nav-number">5.1.</span> <span class="nav-text"> 重定位条目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D%E7%AC%A6%E5%8F%B7%E5%BC%95%E7%94%A8"><span class="nav-number">5.2.</span> <span class="nav-text"> 重定位符号引用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8Dpc%E7%9B%B8%E5%AF%B9%E5%BC%95%E7%94%A8"><span class="nav-number">5.2.1.</span> <span class="nav-text"> 重定位PC相对引用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D%E7%BB%9D%E5%AF%B9%E5%BC%95%E7%94%A8"><span class="nav-number">5.2.2.</span> <span class="nav-text"> 重定位绝对引用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6"><span class="nav-number">6.</span> <span class="nav-text"> 可执行目标文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E5%85%B1%E4%BA%AB%E9%93%BE%E6%8E%A5%E5%BA%93"><span class="nav-number">7.</span> <span class="nav-text"> 动态共享链接库</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Adamska</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">61</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://adamska1008.github.io/2022/06/03/study-notes-CSAPP-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Adamska">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Adamska's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CSAPP笔记（六）—— 链接
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-03 15:39:35" itemprop="dateCreated datePublished" datetime="2022-06-03T15:39:35+08:00">2022-06-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-07-05 15:36:42" itemprop="dateModified" datetime="2022-07-05T15:36:42+08:00">2022-07-05</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CSAPP%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">CSAPP学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>本段内容包括链接的基本内容，静态链接库与动态链接库，库打桩机制。</p>
<span id="more"></span>
<p><strong>链接（linking）</strong> 将各种代码和数据片段收集并组合为一个单一文件。这个文件可以被加载到内存并执行。链接可以执行于编译时（compile time），加载时（load time）甚至运行时（run time）。</p>
<h2 id="静态链接"><a class="markdownIt-Anchor" href="#静态链接"></a> 静态链接</h2>
<p><strong>静态连接器（static linker）</strong> 以一组可重定位目标文件和命令行参数作为输入，生成一个完全链接的、可以加载和运行的可执行目标文件为输出。输入的可重定位目标文件由各种不同的代码和数据节（section）构成。</p>
<p>为了构造可执行文件，链接器必须完成两个主要任务：</p>
<ul>
<li><strong>符号解析（symbol resolution）</strong>。目标文件定义和引用符号，每个符号对应一个函数、全局变量或静态变量。符号解析将每个符号引用和符号定义关联起来。</li>
<li><strong>重定位（relocation）</strong>。编译器和汇编器生成从地址0开始的代码和数据节。链接器通过把每个符号定义与一个内存位置关联起来，而重定位这些节，然后修改符号引用，使得它们指向这个内存位置。</li>
</ul>
<h2 id="目标文件"><a class="markdownIt-Anchor" href="#目标文件"></a> 目标文件</h2>
<p>目标文件有三种形式</p>
<ul>
<li><strong>可重定位目标文件</strong>。</li>
<li><strong>可执行目标文件</strong>。</li>
<li><strong>共享目标文件</strong>。较为特殊，可以在加载或者运行时被动态地加载进内存并链接。</li>
</ul>
<p>编译器和汇编器生成可重定位目标文件与共享目标文件，链接器生成可执行目标文件。一个<strong>目标模块（object module）</strong> 就是一个字节序列，而一个<strong>目标文件（object file）</strong> 就是一个以文件形式存放在磁盘中的目标模块。x86-64 Linux和Unix使用<strong>可执行可链接格式（Executable and Linkable Format, ELF）</strong> 。</p>
<h3 id="可重定位目标文件"><a class="markdownIt-Anchor" href="#可重定位目标文件"></a> 可重定位目标文件</h3>
<p><img src="https://s2.loli.net/2022/06/03/abRD7xsMc9HQzlp.png" alt="7-3.png" /></p>
<p>ELF头以一个16字节的序列开始，描述了生成该文件的操作系统的字的大小和字节顺序。剩下的部分包括ELF头的大小、目标文件的类型、机器类型、节头部表和文件偏移。夹在ELF头和节头部表之间的都是节。一个典型的ELF可重定位目标文件包括：</p>
<ul>
<li><code>.text</code>：已编译程序的机器代码</li>
<li><code>.rodata</code>：只读数据，比如<code>printf</code>语句中的格式串和开关语句的跳转表</li>
<li><code>.data</code>：已初始化的全局和静态C变量。</li>
<li><code>.bss</code>：未初始化的全局和静态C变量，以及所有被初始化为0的全局或静态变量。在目标文件中，这个节仅仅是一个占位符，不占据实际的空间。区分是否初始化，是为了空间效率。</li>
<li><code>.symtab</code>：一个符号表，存放程序中定义和引用的函数和全局变量的信息。</li>
<li><code>.rel.text</code>：一个<code>.text</code>节中，位置的列表。当链接器把这个目标文件和其他文件组合时，需要修改这些位置。可执行目标文件中并不需要，因此通常省略。</li>
<li><code>.rel.data</code>：被模块引用或定义的所有全局变量的重定位信息。</li>
<li><code>.debug</code>：一个调试符号表，其条目是程序中定义的局部变量和类型定义，程序中定义和引用的全局变量以及原始的C源文件。必须使用<code>-g</code>编译才会有。</li>
<li><code>.line</code>：原始C源代码中的行号和<code>.text</code>机器指令之间的映射。必须使用<code>-g</code>编译才会有。</li>
<li><code>.strtab</code>：字符串表。</li>
</ul>
<h2 id="符号和符号表"><a class="markdownIt-Anchor" href="#符号和符号表"></a> 符号和符号表</h2>
<p>在链接器的上下文中，有三种不同的符号：</p>
<ul>
<li>由模块m定义并能被其他模块引用的全局符号。</li>
<li>由其他模块定义并被模块m引用的全局符号。</li>
<li>只被模块m定义和引用的局部符号。</li>
</ul>
<p>带有<code>static</code>属性的本地过程变量不在栈中管理，而处于<code>.data</code>或<code>.bss</code>中，并在符号表中创建一个有唯一名字的本地链接器符号。</p>
<h2 id="符号解析"><a class="markdownIt-Anchor" href="#符号解析"></a> 符号解析</h2>
<p>链接器解析符号引用时，将每个引用与它输入的ELF中的符号表的一个确定的符号定义关联起来。对于引用和定义在相同模块里的局部符号的引用，比较容易。</p>
<p>但全局符号不同。当编译器遇到一个不是在当前模块中定义的符号时，会假设该符号是在其他模块中定义的，生成一个链接器符号表条目，并交给链接器处理。如果在任何输入模块中都找不到，则报错。</p>
<h3 id="解析多重定义的全局符号"><a class="markdownIt-Anchor" href="#解析多重定义的全局符号"></a> 解析多重定义的全局符号</h3>
<p>如果多个模块定义同名的全局符号，则针对符号的强弱性质（强：函数或初始化变量；弱：未初始化变量），有下面的规则：</p>
<ul>
<li>不允许有多个同名的强符号</li>
<li>如果有一个强符号和多个弱符号同名，那么选择强符号</li>
<li>如果有多个弱符号同名，则任意选择。</li>
</ul>
<h3 id="与静态库链接"><a class="markdownIt-Anchor" href="#与静态库链接"></a> 与静态库链接</h3>
<p>将所有相关的目标模块打包成为一个单独的文件，称为<strong>静态库（static library）</strong> 。</p>
<p>在链接时，链接器将只复制被程序引用的目标模块，这就减少了可执行文件在磁盘和内存中的大小，也方便程序员包含库文件。在Linux系统中，静态库作为**存档（archive）**文件存放在磁盘中。</p>
<h3 id="静态库解析引用"><a class="markdownIt-Anchor" href="#静态库解析引用"></a> 静态库解析引用</h3>
<p>在符号解析阶段，链接器逐个解析目标文件或存档文件。</p>
<p>记一个可重定位目标文件集合<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span></span></span></span>，未解析符号<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span></span></span></span>，以及已定义符号集合<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span></span></span></span>。在扫描过程中：</p>
<ul>
<li>对每个输入文件<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span></span></span></span>，链接器判断其为目标文件还是存档文件。目标文件则添加至<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span></span></span></span>，修改<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span></span></span></span>。</li>
<li>如果是存档文件，则尝试匹配<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span></span></span></span>中未解析符号。如果某个存档文件成员<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">m</span></span></span></span>定义了对应符号，则将<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">m</span></span></span></span>加入<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span></span></span></span>并修改<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span></span></span></span>。</li>
<li>如果最后<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span></span></span></span>非空，则报错并终止。</li>
</ul>
<p>在这种算法下，如果定义一个符号的库出现在引用这个符号的目标文件之前，那么引用就不能被解析。</p>
<h2 id="重定位"><a class="markdownIt-Anchor" href="#重定位"></a> 重定位</h2>
<p>一旦链接器完成了符号解析，就可以开始重定位。重定位由两部分组成：</p>
<ul>
<li><em>重定位节和符号定义</em>。 链接器将所有相同类型的节合并为同一类型的新的聚合节，例如合并所有的<code>.data</code>。然后，链接器将运行时内存地址赋给新的聚合节，赋给输入模块定义的每个节和符号。</li>
<li><em>重定位节中的符号引用</em>。在这一步中，链接器修改代码节和数据节中对每个符号的引用，使得它们指向正确的运行时地址。这依赖于<strong>重定位条目（relocation entry）</strong> 。</li>
</ul>
<h3 id="重定位条目"><a class="markdownIt-Anchor" href="#重定位条目"></a> 重定位条目</h3>
<p>当汇编器生成一个目标模块时，它并不知道数据和代码最终将放在内存中的什么位置。当汇编器遇到位置的目标引用，就会生成重定位条目，存放在<code>.rel.text</code>和<code>.rel.data</code>中。</p>
<p>重定位条目的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> offset;        <span class="comment">// Offset of the reference to relocate</span></span><br><span class="line">    <span class="keyword">long</span> type:<span class="number">32</span>,       <span class="comment">// Relocation type</span></span><br><span class="line">         symbol:<span class="number">32</span>;     <span class="comment">// Symbol table index</span></span><br><span class="line">    <span class="keyword">long</span> addend;        <span class="comment">// Constant part of relocation expression</span></span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure>
<p><code>Offset</code>是需要被修改的节引用偏移量，<code>symbol</code>表示被修改引用应该指向的符号，<code>type</code>告知链接器如何修改新的引用，一些类型的重定位使用<code>addend</code>对被修改引用的值作偏移调整。</p>
<p>有两种最基本的重定位类型：</p>
<ul>
<li><code>R_X86_64_PC32</code>：重定位一个使用32位PC相对地址的引用。一个PC相对地址就是距PC的当前运行值的偏移量。CPU用指令中编码的32位值加上PC的值，得到有效地址。</li>
<li><code>R_x86_64_32</code>：绝对地址。不需要修改。</li>
</ul>
<h3 id="重定位符号引用"><a class="markdownIt-Anchor" href="#重定位符号引用"></a> 重定位符号引用</h3>
<p>假设每个节为<code>s</code>，每个节相关联的重定位条目为<code>r</code>，重定位算法可以用伪代码表示为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">foreach section s &#123;</span><br><span class="line">    foreach relocation entry r &#123;</span><br><span class="line">        refptr = s + r.offset; // ptr to reference to be relocated</span><br><span class="line"></span><br><span class="line">        if (r.type == R_X86_64_PC32) &#123;</span><br><span class="line">            refaddr = ADDR(s) + r.offset;</span><br><span class="line">            *refptr = (unsigned)(ADDR(r.symbol) + r.addend);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (r.type == R_X86_64_32)</span><br><span class="line">            *refptr = (unsigned)(ADDR(r.symbol) + r.addend);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例如如下反汇编代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0000000000000000 &lt;main&gt;:</span><br><span class="line">    0:  48 83 ec 08             sub     $0x8, %rsp</span><br><span class="line">    4:  be 02 00 00 00          mov     $0x2, %esi</span><br><span class="line">    9:  bf 00 00 00 00          mov     $0x0, %edi          %edi = &amp;array</span><br><span class="line">                        a: R_X86_64_32 array                Relocation entry</span><br><span class="line"></span><br><span class="line">    e:  e8 00 00 00 00          callq 13&lt;main+0x13&gt;         sum()</span><br><span class="line">                        f: R_X86_64_PC32 sum-0x4            Relocation entry</span><br><span class="line">    13: 48 83 c4 08             add     $0x8, %rsp</span><br><span class="line">    17: c3                      retq</span><br></pre></td></tr></table></figure>
<p><code>main</code>函数引用了两个全局符号：<code>array</code>和<code>sum</code>。为每个引用，汇编器产生一个重定位条目，显示在引用后面的一行上。</p>
<h4 id="重定位pc相对引用"><a class="markdownIt-Anchor" href="#重定位pc相对引用"></a> 重定位PC相对引用</h4>
<p>以<code>sum</code>为例，相对应的重定位条目<code>r</code>为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">r.offset = <span class="number">0xf</span></span><br><span class="line">r.symbol = sum</span><br><span class="line">r.type = R_x86_64_PC32</span><br><span class="line">r.addend = <span class="number">-4</span></span><br></pre></td></tr></table></figure>
<p><code>call</code>指令开始于节偏移<code>0xe</code>的地方，这些字段告诉链接器修改位于<code>0xf</code>处的32位PC相对引用。假设有<code>ADDR(s) = ADDR(.text) = 0x4004d0</code>，重定位后代码段的实际地址是<code>0x4004d0</code> 和 <code>ADDR(r.symbol) = ADDR(sum) = 0x4004e8</code>，需要调用的<code>sum</code>地址是<code>0x400e8</code></p>
<p>根据算法，首先算出引用的运行时地址，显然是<code>0x4004df</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">refaddr = ADDR(s) + r.offset</span><br><span class="line">        = <span class="number">0x4004d0</span> + <span class="number">0xf</span></span><br><span class="line">        = <span class="number">0x4004df</span></span><br></pre></td></tr></table></figure>
<p>然后，更新该引用，使得它在运行时指向sum程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*refptr = (<span class="keyword">unsigned</span>)(ADDR(r.symbol) + r.addend - refaddr)</span><br><span class="line">        = (<span class="keyword">unsigned</span>)(<span class="number">0x4004e8</span>       + (<span class="number">-4</span>)     - <span class="number">0x4004df</span>)</span><br><span class="line">        = (<span class="keyword">unsigned</span>)(<span class="number">0x5</span>)</span><br></pre></td></tr></table></figure>
<p>得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4004de:     e8 05 00 00 00          callq   4004e8 &lt;sum&gt; </span><br></pre></td></tr></table></figure>
<p>执行<code>call</code>指令时，PC为<code>0x4004e3</code>，先把PC压入栈中，随后相对寻址PC = PC + 0x5，得到<code>sum</code>第一条指令的地址。</p>
<h4 id="重定位绝对引用"><a class="markdownIt-Anchor" href="#重定位绝对引用"></a> 重定位绝对引用</h4>
<p>以<code>array</code>为例，<code>mov</code>指令开始于<code>0x9</code>，对应重定位条目<code>r</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">r.offset = <span class="number">0xa</span></span><br><span class="line">r.symbol = <span class="built_in">array</span></span><br><span class="line">r.type   = R_X86_64_32</span><br><span class="line">r.addend = <span class="number">0</span> </span><br></pre></td></tr></table></figure>
<p>假设有<code>ADDR(r.symbol) = ADDR(array) = 0x601018</code>，则直接修改</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*refptr = (<span class="keyword">unsigned</span>)(ADDR(r.symbol) + r.addend)</span><br><span class="line">        = (<span class="keyword">unsigned</span>)(<span class="number">0x601018</span>       + <span class="number">0</span>)</span><br><span class="line">        = (<span class="keyword">unsigned</span>)(<span class="number">0x601018</span>)</span><br></pre></td></tr></table></figure>
<p>故原指令重定位为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4004</span>d9:     bf <span class="number">18</span> <span class="number">10</span> <span class="number">60</span> <span class="number">00</span>          mov     $<span class="number">0x601018</span>, %edi</span><br></pre></td></tr></table></figure>
<h2 id="可执行目标文件"><a class="markdownIt-Anchor" href="#可执行目标文件"></a> 可执行目标文件</h2>
<p><img src="https://s2.loli.net/2022/06/05/ZxtY869l7IHJaG1.png" alt="7-13.png" /></p>
<p>相较于可重定位目标文件，ELF头中包含了程序的<em>入口点（entry point）</em>，不需要<code>.rel</code>节，</p>
<p>要加载可执行目标文件，可以直接运行。通过<strong>加载器（loader）</strong> 可以运行程序。使用<code>execve</code>等函数可以调用加载器。将程序复制到内存并运行，称作加载。</p>
<p>每个程序都有运行时内存映像。</p>
<h2 id="动态共享链接库"><a class="markdownIt-Anchor" href="#动态共享链接库"></a> 动态共享链接库</h2>
<p><strong>共享库（shared library）</strong> 是一个目标模块，在运行或加载时，可以加载到任意内存地址，并和一个在内存中的程序链接。这个过程称为<strong>动态链接（dynamic linking）</strong> ，是由<strong>动态链接器（dynamic linker）</strong> 来执行的。</p>
<p><img src="https://s2.loli.net/2022/06/03/HlouNzSfXPjQdhI.png" alt="7-16.png" /></p>
<p>共享库以两种不同方式来共享。所有引用共享库的可执行目标文件共享一个动态链接库文件。在内存中，一个库的<code>.text</code>节可以被不同进程共享。动态链接器完成以下链接任务：</p>
<ul>
<li>重定位<code>.so</code>的文本和数据到某个内存段</li>
<li>重定位程序中对<code>.so</code>定义的符号引用</li>
</ul>
<p>当程序中主动调用动态链接库时，引入代码段和数据。</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Adamska
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://adamska1008.github.io/2022/06/03/study-notes-CSAPP-6/" title="CSAPP笔记（六）—— 链接">https://adamska1008.github.io/2022/06/03/study-notes-CSAPP-6/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/CSAPP/" rel="tag"># CSAPP</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/06/02/study-notes-CSAPP-5/" rel="prev" title="CSAPP笔记（五）—— 存储器层次结构">
                  <i class="fa fa-chevron-left"></i> CSAPP笔记（五）—— 存储器层次结构
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/06/03/study-notes-CSAPP-7/" rel="next" title="CSAPP笔记（七）—— 异常控制流">
                  CSAPP笔记（七）—— 异常控制流 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Adamska</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.13.2/dist/mermaid.min.js","integrity":"sha256-UIQPVkGifpwMvDH5yGgORJ9sSTDq38zz6BGU6dNaKhM="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>



  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css" integrity="sha256-M6KFoDq9eUpmogkDgw6+3R3ZgUPSuFXnQyr8tskSfQs=" crossorigin="anonymous">



</body>
</html>
